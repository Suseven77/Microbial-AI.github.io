<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç»†èŒåˆ†æ AI æ™ºèƒ½ä½“ â€” ä¸“ä¸šç‰ˆ</title>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#6ee7b7; --glass: rgba(255,255,255,0.04);
      --glass-2: rgba(255,255,255,0.02); --danger:#ff6b6b;
      --radius:14px; --shadow: 0 6px 24px rgba(2,6,23,0.6);
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background: linear-gradient(180deg,#071026 0%, #081022 60%); color:#e6eef6}
    .app{display:grid;grid-template-columns:300px 1fr 360px;gap:20px;padding:24px;height:100vh}

    /* Left sidebar */
    .sidebar{background:linear-gradient(180deg,var(--card), #06101a);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:flex;align-items:center;justify-content:center;font-weight:700;color:#022;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    .title{font-size:16px;font-weight:700}
    .subtitle{font-size:12px;color:var(--muted)}
    .menu{margin-top:8px;display:flex;flex-direction:column;gap:6px}
    .menu button{background:var(--glass);border:1px solid rgba(255,255,255,0.03);padding:10px;border-radius:10px;color:inherit;text-align:left;cursor:pointer}
    .menu button.active{background:linear-gradient(90deg, rgba(110,231,183,0.08), rgba(96,165,250,0.03));border:1px solid rgba(110,231,183,0.14)}
    .status{margin-top:auto;padding-top:8px;border-top:1px dashed rgba(255,255,255,0.03);font-size:13px;color:var(--muted)}

    /* Main area */
    .main{display:flex;flex-direction:column;gap:16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.02);box-shadow: 0 10px 30px rgba(2,6,23,0.6)}
    .controls{display:flex;gap:12px;align-items:center}
    textarea.seq{width:100%;height:160px;background:transparent;color:inherit;border:1px dashed rgba(255,255,255,0.04);padding:12px;border-radius:8px;font-family:monospace;font-size:13px;resize:vertical}
    .row{display:flex;gap:12px}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:var(--accent);color:#022;font-weight:600}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .small{font-size:13px;padding:8px 10px}
    .loading{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite}

    /* right panel */
    .right{display:flex;flex-direction:column;gap:12px}
    .panel-title{font-weight:700}
    .result{white-space:pre-wrap;font-family:Inter,monospace;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);min-height:120px}

    /* history */
    .history{max-height:220px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
    .history .item{background:var(--glass-2);padding:8px;border-radius:8px;font-size:13px;color:var(--muted)}

    /* ä¸»åŒºåŸŸå†å²è®°å½•æ ·å¼ */
    .history-main{max-height:500px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
    .history-main .item{background:var(--glass-2);padding:12px;border-radius:8px;font-size:14px;color:var(--muted);line-height:1.4}

    /* çŸ¥è¯†åº“ç­”æ¡ˆæ ·å¼ */
    .kb-answer-container {
      margin-top: 16px;
      padding: 16px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(110,231,183,0.08), rgba(96,165,250,0.05));
      border: 1px solid rgba(110,231,183,0.15);
      box-shadow: 0 4px 20px rgba(2,6,23,0.4);
      transition: all 0.3s ease;
      max-height: 600px;
      overflow-y: auto;
    }

    .kb-answer-title {
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .kb-answer-content {
      line-height: 1.6;
      color: #e6eef6;
      white-space: pre-wrap;
      font-family: Inter, sans-serif;
      margin-bottom: 16px;
    }

    /* åˆ†ææŠ¥å‘Šæ ‡é¢˜æ ·å¼ */
    .analysis-report-title {
      font-size: 1.2em;
      font-weight: 400;
      color: #ffefcb;
      margin-bottom: 8px;
      text-align: center;
      padding: 8px;
      border-radius: 8px;
      background: linear-gradient(135deg, rgba(255,209,102,0.1), rgba(255,209,102,0.05));
      border: 1px solid rgba(255,209,102,0.2);
    }

    /* åˆ†æç»“æœåŒºåŸŸæ ·å¼ */
    .analysis-result-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: 100%;
    }

    .result-area {
      flex: 0.8;
      display: flex;
      flex-direction: column;
      min-height: 300px;
    }

    .result-content {
      flex: 1;
      white-space: pre-wrap;
      font-family: Inter, monospace;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
      padding: 16px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.02);
      overflow-y: auto;
      font-size: 15px;
      line-height: 1.6;
      max-height: calc(100vh - 400px);
    }

    .stats-panel {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }

    .stats-panel > div {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      background: var(--glass-2);
      border: 1px solid rgba(255,255,255,0.02);
    }

    /* æ¦‚ç‡åˆ†å¸ƒå®¹å™¨ - æ·»åŠ æ»šåŠ¨æ¡ */
    .probability-container {
      max-height: 180px;
      overflow-y: auto;
      padding-right: 8px;
      margin-top: 8px;
    }

    /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
    .probability-container::-webkit-scrollbar {
      width: 8px;
    }

    .probability-container::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
    }

    .probability-container::-webkit-scrollbar-thumb {
      background: rgba(110,231,183,0.3);
      border-radius: 4px;
    }

    .probability-container::-webkit-scrollbar-thumb:hover {
      background: rgba(110,231,183,0.5);
    }

    /* é›·è¾¾å›¾å®¹å™¨æ ·å¼ - å¢å¤§å°ºå¯¸ */
    .radar-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 280px;
      margin-top: 10px;
    }

    .radar-chart {
      width: 100%;
      height: 100%;
    }

    /* çŸ¥è¯†åº“é›·è¾¾å›¾å®¹å™¨ - å¢å¤§å°ºå¯¸ */
    .kb-radar-container {
      margin-top: 16px;
      text-align: center;
      border-top: 1px solid rgba(255,255,255,0.05);
      padding-top: 16px;
    }

    .kb-radar-title {
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--accent);
      font-size: 14px;
    }

    .kb-radar-image {
      max-width: 100%;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.05);
      max-height: 1000px;
    }

    /* è­¦å‘Šå¯¹è¯æ¡†æ ·å¼ */
    .warning-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .warning-content {
      background: linear-gradient(135deg, #0b1220, #071026);
      border-radius: var(--radius);
      padding: 24px;
      width: 90%;
      max-width: 480px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.05);
    }

    .warning-title {
      font-weight: 700;
      margin-bottom: 8px;
      color: #ffcc00;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .warning-body {
      margin: 16px 0;
      line-height: 1.5;
      color: #e6eef6;
    }

    .warning-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 20px;
    }

    .warning-btn {
      padding: 10px 18px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }

    .warning-btn.primary {
      background: var(--accent);
      color: #022;
    }

    .warning-btn.secondary {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--muted);
    }

    /* æ¦‚ç‡åˆ†å¸ƒé•¿æ¡å½¢æ ·å¼ */
    .probability-bars {
      margin-top: 12px;
    }

    .probability-bar {
      margin-bottom: 10px;
    }

    .probability-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 13px;
      color: var(--muted);
    }

    .probability-bar-bg {
      height: 8px;
      background: rgba(255,255,255,0.05);
      border-radius: 4px;
      overflow: hidden;
    }

    .probability-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #6ee7b7, #60a5fa);
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    /* responsive */
    @media (max-width:1100px){.app{grid-template-columns:1fr;grid-auto-rows:auto;padding:12px}.right{order:3}.sidebar{order:1}.main{order:2}}

    /* small helpers */
    .meta{font-size:12px;color:var(--muted)}
    .kbd{background:#071423;padding:4px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);font-family:monospace}

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }

    .upload-server-btn {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 12px 20px;
      border-radius: 10px;
      background: linear-gradient(135deg, #60a5fa, #6ee7b7);
      color: #022;
      font-weight: 600;
      text-decoration: none;
      box-shadow: 0 6px 20px rgba(2,6,23,0.6);
      z-index: 100;
      transition: all 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: sidebar -->
    <aside class="sidebar card">
      <div class="brand">
        <div class="logo">AI</div>
        <div>
          <div class="title">ç»†èŒåˆ†æ AI æ™ºèƒ½ä½“</div>
          <div class="subtitle">DNA åˆ†ç±» Â· ç‰¹æ€§æŸ¥è¯¢ Â· èŒç§é¢„æµ‹</div>
        </div>
      </div>

      <div class="menu">
        <button id="menu-analyze" class="active">ğŸ”¬ åºåˆ—åˆ†æ</button>
        <button id="menu-query">ğŸ“š çŸ¥è¯†åº“æŸ¥è¯¢</button>
        <button id="menu-history">ğŸ“ å¯¹è¯å†å²</button>
      </div>

      <div class="status">
        <div>APIçŠ¶æ€: <strong id="api-status">æœªè¿æ¥</strong></div>
        <div class="meta">æœåŠ¡å™¨: <span id="server-url">http://localhost:5000</span></div>

        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="small ghost" id="btn-test-api">æµ‹è¯•è¿æ¥</button>
        </div>
      </div>
    </aside>

    <!-- CENTER: main interaction -->
    <main class="main">
      <section class="card" id="input-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div>
            <div style="font-weight:700">è¾“å…¥ DNA åºåˆ—</div>
            <div class="meta">æ”¯æŒ ATCGN å­—ç¬¦ï¼Œé•¿åº¦å»ºè®® â‰¥ 1500 bp</div>
          </div>
          <div class="meta">ç¤ºä¾‹: <span class="kbd">ctrl+enter</span> ç«‹åˆ»åˆ†æ</div>
        </div>

        <textarea id="sequence-input" class="seq" placeholder="åœ¨æ­¤ç²˜è´´æˆ–è¾“å…¥ DNA åºåˆ—ï¼ˆåªå…è®¸ A/T/C/G/N ç­‰å­—ç¬¦ï¼‰..."></textarea>

        <div class="controls" style="margin-top:12px">
          <button class="btn" id="btn-analyze">
            <span id="analyze-text">åˆ†æåºåˆ—</span>
            <span id="analyze-loading" class="loading" style="display:none"></span>
          </button>
          <button class="btn ghost" id="btn-clear">æ¸…ç©º</button>
          <button class="btn ghost" id="btn-sample">åŠ è½½ç¤ºä¾‹åºåˆ—</button>
        </div>
      </section>

      <section class="card" id="knowledge-card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div>
            <div style="font-weight:700">çŸ¥è¯†åº“é—®ç­”</div>
            <div class="meta">è¯¢é—®å…³äº43ç§èŒç§çš„ç‰¹æ€§</div>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <input id="kb-input" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit" placeholder="ä¾‹: æ ¼æ°ä¹³æ†èŒçš„è€é…¸æ€§å¦‚ä½•ï¼Ÿ" />
          <button class="btn" id="btn-kb">
            <span id="kb-text">æŸ¥è¯¢</span>
            <span id="kb-loading" class="loading" style="display:none"></span>
          </button>
        </div>

        <!-- çŸ¥è¯†åº“ç­”æ¡ˆæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="kb-answer-container" class="kb-answer-container" style="display:none">
          <div class="kb-answer-title">ğŸ’¡ çŸ¥è¯†åº“ç­”æ¡ˆ</div>
          <div id="kb-answer-content" class="kb-answer-content"></div>
          <!-- çŸ¥è¯†åº“é›·è¾¾å›¾å®¹å™¨ -->
          <div id="kb-radar-container" class="kb-radar-container" style="display:none">
            <div id="kb-radar-image-container"></div>
          </div>
        </div>
      </section>

      <section class="card" id="analysis-visual" style="display:block">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">åˆ†æç»“æœ</div>
          <div class="meta">æ¨¡å‹è¾“å‡º Â· ç½®ä¿¡åº¦ Â· å»ºè®®</div>
        </div>

        <div class="analysis-result-container">
          <div class="result-area">
            <div class="result-content" id="result-output">æš‚æ— åˆ†æç»“æœã€‚è¯·å…ˆè¾“å…¥åºåˆ—å¹¶ç‚¹å‡»"åˆ†æåºåˆ—"ã€‚</div>
          </div>

          <div class="stats-panel">
            <div>
              <div class="panel-title">æ¦‚ç‡åˆ†å¸ƒ</div>
              <!-- æ¦‚ç‡åˆ†å¸ƒå®¹å™¨ï¼Œæ·»åŠ æ»šåŠ¨æ¡ -->
              <div id="probability-container" class="probability-container">
                <div id="probability-bars" class="probability-bars">
                  <div class="probability-bar">
                    <div class="probability-label">
                      <span>æš‚æ— æ•°æ®</span>
                      <span>0%</span>
                    </div>
                    <div class="probability-bar-bg">
                      <div class="probability-bar-fill" style="width: 0%"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <div class="panel-title">æ€§èƒ½é›·è¾¾å›¾</div>
              <div id="advice" class="meta" style="line-height:1.4">
                <div id="radar-container" class="radar-container">
                  <canvas id="radar-chart" class="radar-chart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ä¸»åŒºåŸŸå†å²è®°å½• -->
      <section class="card" id="history-main-card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">å¯¹è¯å†å²</div>
          <div class="meta">å®Œæ•´å¯¹è¯è®°å½• Â· å¯å¯¼å‡ºä¿å­˜</div>
        </div>
        <div class="history-main" id="history-main-list">
          <div class="item">æš‚æ— å†å²è®°å½•</div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn ghost" id="btn-clear-history-main">æ¸…ç©ºå†å²</button>
          <button class="btn ghost" id="btn-export-main">å¯¼å‡ºè®°å½•</button>
        </div>
      </section>
    </main>

    <!-- RIGHT: history & settings -->
    <aside class="right">
      <div class="card">
        <div class="panel-title">å¯¹è¯å†å²</div>
        <div class="history" id="history-list">
          <div class="item">æš‚æ— å†å²è®°å½•</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="small ghost" id="btn-clear-history">æ¸…ç©ºå†å²</button>
          <button class="small ghost" id="btn-export">å¯¼å‡ºè®°å½•</button>
        </div>
      </div>

      <div class="card">
        <div class="panel-title">APIè®¾ç½®</div>
        <div style="display:flex;flex-direction:column;gap:6px;margin-top:8px">
          <label class="meta">æœåŠ¡å™¨åœ°å€:
            <input id="api-url" type="text" value="http://localhost:5000" style="width:100%;padding:6px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:inherit;font-size:12px" />
          </label>
        </div>
      </div>

      <div class="card" style="text-align:center">
        <div class="meta">ç‰ˆæœ¬: 2.0</div>
        <div class="meta">AIæ¨¡å‹é©±åŠ¨ Â· å®æ—¶åˆ†æ</div>
      </div>
    </aside>
  </div>

  <!-- åºåˆ—é•¿åº¦è­¦å‘Šå¯¹è¯æ¡† -->
  <div id="warning-modal" class="warning-modal" style="display:none">
    <div class="warning-content">
      <div class="warning-title">âš ï¸ åºåˆ—é•¿åº¦è­¦å‘Š</div>
      <div class="warning-body">
        æ‚¨è¾“å…¥çš„åºåˆ—é•¿åº¦ä¸º <span id="sequence-length">0</span> bpï¼Œå°äºæ¨èçš„ 1500 bpã€‚
        <br><br>
        è¾ƒçŸ­çš„åºåˆ—å¯èƒ½å¯¼è‡´åˆ†æç»“æœä¸å¤Ÿå‡†ç¡®ã€‚æ‚¨ç¡®å®šè¦ç»§ç»­åˆ†æå—ï¼Ÿ
      </div>
      <div class="warning-actions">
        <button class="warning-btn secondary" id="warning-cancel">å–æ¶ˆåˆ†æ</button>
        <button class="warning-btn primary" id="warning-continue">ç»§ç»­åˆ†æ</button>
      </div>
    </div>
  </div>

  <!-- å¼•å…¥Chart.jsåº“ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    // å¦‚æœChart.jsåŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨CDN
    if (typeof Chart === 'undefined') {
      document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"><\/script>');
    }
  </script>
  <script>
    // APIé…ç½®
    const API_CONFIG = {
      baseURL: 'http://localhost:5000',
      endpoints: {
        analyze: '/analyze',
        query: '/query',
        status: '/status'
      }
    };

    // DOMå…ƒç´ 
    const seqInput = document.getElementById('sequence-input');
    const btnAnalyze = document.getElementById('btn-analyze');
    const resultOutput = document.getElementById('result-output');
    const historyList = document.getElementById('history-list');
    const historyMainList = document.getElementById('history-main-list');
    const btnClear = document.getElementById('btn-clear');
    const btnSample = document.getElementById('btn-sample');
    const apiStatus = document.getElementById('api-status');
    const serverUrl = document.getElementById('server-url');
    const apiUrlInput = document.getElementById('api-url');
    const btnTestApi = document.getElementById('btn-test-api');
    const analyzeText = document.getElementById('analyze-text');
    const analyzeLoading = document.getElementById('analyze-loading');
    const kbText = document.getElementById('kb-text');
    const kbLoading = document.getElementById('kb-loading');
    const inputSection = document.getElementById('input-section');
    const knowledgeCard = document.getElementById('knowledge-card');
    const analysisVisual = document.getElementById('analysis-visual');
    const historyMainCard = document.getElementById('history-main-card');
    const kbAnswerContainer = document.getElementById('kb-answer-container');
    const kbAnswerContent = document.getElementById('kb-answer-content');
    const kbInput = document.getElementById('kb-input');
    const radarCanvas = document.getElementById('radar-chart');
    const kbRadarContainer = document.getElementById('kb-radar-container');
    const kbRadarImageContainer = document.getElementById('kb-radar-image-container');
    const probabilityBars = document.getElementById('probability-bars');

    // è­¦å‘Šå¯¹è¯æ¡†å…ƒç´ 
    const warningModal = document.getElementById('warning-modal');
    const warningCancel = document.getElementById('warning-cancel');
    const warningContinue = document.getElementById('warning-continue');
    const sequenceLength = document.getElementById('sequence-length');

    // å›¾è¡¨å®ä¾‹
    let radarChart = null;
    let kbRadarChart = null;

    // æ ¼å¼åŒ–åˆ†ææŠ¥å‘Š
    function formatAnalysisReport(report) {
      if (!report) return report;

      // ç§»é™¤åˆ†éš”çº¿
      let formattedReport = report.replace(/=+/g, '');

      // æ›¿æ¢æ ‡é¢˜
      formattedReport = formattedReport.replace(/ğŸ§¬ DNAåºåˆ—åˆ†ææŠ¥å‘Š \(.*?\)/, '');

      return formattedReport;
    }

    // æ›´æ–°APIé…ç½®
    function updateApiConfig() {
      API_CONFIG.baseURL = apiUrlInput.value;
      serverUrl.textContent = apiUrlInput.value;
    }

    // APIè°ƒç”¨å‡½æ•°
    async function callAPI(endpoint, data) {
      updateApiConfig();

      try {
        const response = await fetch(`${API_CONFIG.baseURL}${endpoint}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return await response.json();
      } catch (error) {
        console.error('APIè°ƒç”¨å¤±è´¥:', error);
        throw error;
      }
    }

    // æµ‹è¯•APIè¿æ¥
    async function testApiConnection() {
      updateApiConfig();
      apiStatus.textContent = 'æµ‹è¯•ä¸­...';
      apiStatus.style.color = 'orange';

      try {
        const response = await fetch(`${API_CONFIG.baseURL}${API_CONFIG.endpoints.status}`);
        if (response.ok) {
          apiStatus.textContent = 'å·²è¿æ¥';
          apiStatus.style.color = '#6ee7b7';
          return true;
        } else {
          throw new Error('çŠ¶æ€æ£€æŸ¥å¤±è´¥');
        }
      } catch (error) {
        apiStatus.textContent = 'è¿æ¥å¤±è´¥';
        apiStatus.style.color = '#ff6b6b';
        return false;
      }
    }

    // åˆ†æDNAåºåˆ—
    async function analyzeSequence(sequence) {
      if (!sequence || sequence.length < 50) {
        throw new Error('è¯·è¾“å…¥é•¿åº¦ä¸å°äº50çš„DNAåºåˆ—');
      }

      // éªŒè¯åºåˆ—æ ¼å¼
      const dnaRegex = /^[ATCGNatcgn\s]+$/;
      if (!dnaRegex.test(sequence)) {
        throw new Error('åºåˆ—åŒ…å«éæ³•å­—ç¬¦ï¼Œåªå…è®¸A,T,C,G,Nå­—ç¬¦');
      }

      const data = {
        sequence: sequence.toUpperCase()
      };

      return await callAPI(API_CONFIG.endpoints.analyze, data);
    }

    // æŸ¥è¯¢çŸ¥è¯†åº“
    async function queryKnowledge(question) {
      if (!question.trim()) {
        throw new Error('è¯·è¾“å…¥æŸ¥è¯¢å†…å®¹');
      }

      const data = { question: question };
      return await callAPI(API_CONFIG.endpoints.query, data);
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function setLoading(button, textElement, loadingElement, isLoading) {
      if (isLoading) {
        textElement.style.display = 'none';
        loadingElement.style.display = 'inline-block';
        button.disabled = true;
      } else {
        textElement.style.display = 'inline';
        loadingElement.style.display = 'none';
        button.disabled = false;
      }
    }

    // ç»˜åˆ¶æ¦‚ç‡åˆ†å¸ƒé•¿æ¡å½¢å›¾
    function drawProbabilityBars(probabilities) {
      const container = document.getElementById('probability-bars');
      container.innerHTML = '';

      // å¦‚æœæ²¡æœ‰æ¦‚ç‡æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
      if (!probabilities || Object.keys(probabilities).length === 0) {
        container.innerHTML = `
          <div class="probability-bar">
            <div class="probability-label">
              <span>æš‚æ— æ•°æ®</span>
              <span>0%</span>
            </div>
            <div class="probability-bar-bg">
              <div class="probability-bar-fill" style="width: 0%"></div>
            </div>
          </div>
        `;
        return;
      }

      // æŒ‰æ¦‚ç‡å€¼æ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰
      const sortedEntries = Object.entries(probabilities).sort((a, b) => b[1] - a[1]);

      // ä¸ºæ¯ä¸ªæ¦‚ç‡åˆ›å»ºæ¡å½¢
      sortedEntries.forEach(([className, prob]) => {
        const percentage = (prob * 100).toFixed(1);

        const barElement = document.createElement('div');
        barElement.className = 'probability-bar';

        barElement.innerHTML = `
          <div class="probability-label">
            <span>${className}</span>
            <span>${percentage}%</span>
          </div>
          <div class="probability-bar-bg">
            <div class="probability-bar-fill" style="width: ${percentage}%"></div>
          </div>
        `;

        container.appendChild(barElement);
      });
    }

    // ç»˜åˆ¶é›·è¾¾å›¾ - å‚ç…§ä»£ç 3çš„æ”¹è¿›ç‰ˆæœ¬
    function drawRadarChart(radarData, strainName, canvasElement, chartInstance) {
      // å¦‚æœå·²æœ‰é›·è¾¾å›¾å®ä¾‹ï¼Œå…ˆé”€æ¯
      if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
      }

      // æ£€æŸ¥æ˜¯å¦æœ‰é›·è¾¾å›¾æ•°æ®
      if (!radarData || (radarData.labels && radarData.labels.length === 0)) {
        if (canvasElement.parentElement) {
          canvasElement.parentElement.innerHTML = '<div style="color: var(--muted); text-align: center;">æš‚æ— é›·è¾¾å›¾æ•°æ®</div>';
        }
        return null;
      }

      // ç¡®ä¿Chart.jså·²åŠ è½½
      if (typeof Chart === 'undefined') {
        console.error('Chart.jsæœªæ­£ç¡®åŠ è½½');
        if (canvasElement.parentElement) {
          canvasElement.parentElement.innerHTML = '<div style="color: var(--muted); text-align: center;">å›¾è¡¨åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
        }
        return null;
      }

      // å‡†å¤‡é›·è¾¾å›¾æ•°æ®
      let labels, datasets;

      // å¤„ç†ä¸åŒç±»å‹çš„é›·è¾¾å›¾æ•°æ®
      if (radarData.datasets) {
        // å¯¹æ¯”é›·è¾¾å›¾æ•°æ®
        labels = radarData.labels;
        datasets = radarData.datasets;
      } else {
        // å•ä¸ªé›·è¾¾å›¾æ•°æ®
        labels = radarData.labels;
        datasets = [{
          label: strainName || 'èŒæ ª',
          data: radarData.values,
          backgroundColor: 'rgba(110, 231, 183, 0.2)',
          borderColor: 'rgba(110, 231, 183, 0.8)',
          pointBackgroundColor: 'rgba(110, 231, 183, 1)',
          pointBorderColor: '#fff',
          pointHoverBackgroundColor: '#fff',
          pointHoverBorderColor: 'rgba(110, 231, 183, 1)',
          borderWidth: 2,
          pointRadius: 4
        }];
      }

      try {
        // åˆ›å»ºé›·è¾¾å›¾
        const ctx = canvasElement.getContext('2d');
        const newChart = new Chart(ctx, {
          type: 'radar',
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                angleLines: {
                  color: 'rgba(255, 255, 255, 0.1)'
                },
                grid: {
                  color: 'rgba(255, 255, 255, 0.1)'
                },
                pointLabels: {
                  color: '#e6eef6',
                  font: {
                    size: 12,
                    family: 'Inter, sans-serif'
                  },
                  padding: 15
                },
                ticks: {
                  color: 'rgba(255, 255, 255, 0.5)',
                  backdropColor: 'transparent',
                  stepSize: 20,
                  showLabelBackdrop: false,
                  font: {
                    size: 10
                  }
                },
                suggestedMin: 0,
                suggestedMax: 100
              }
            },
            plugins: {
              legend: {
                position: 'top',
                labels: {
                  color: '#e6eef6',
                  font: {
                    size: 14
                  },
                  padding: 15
                }
              },
              tooltip: {
                backgroundColor: 'rgba(11, 18, 32, 0.9)',
                titleColor: '#6ee7b7',
                bodyColor: '#e6eef6',
                borderColor: 'rgba(110, 231, 183, 0.3)',
                borderWidth: 1,
                titleFont: {
                  size: 12
                },
                bodyFont: {
                  size: 11
                }
              }
            },
            elements: {
              line: {
                tension: 0.1
              }
            }
          }
        });

        return newChart;
      } catch (error) {
        console.error('åˆ›å»ºé›·è¾¾å›¾å¤±è´¥:', error);
        if (canvasElement.parentElement) {
          canvasElement.parentElement.innerHTML = '<div style="color: var(--muted); text-align: center;">é›·è¾¾å›¾ç”Ÿæˆå¤±è´¥</div>';
        }
        return null;
      }
    }

    // åˆ‡æ¢èœå•
    document.getElementById('menu-analyze').addEventListener('click', ()=>{showPanel('analyze')});
    document.getElementById('menu-query').addEventListener('click', ()=>{showPanel('query')});
    document.getElementById('menu-history').addEventListener('click', ()=>{showPanel('history')});

    function showPanel(name){
      document.querySelectorAll('.menu button').forEach(b=>b.classList.remove('active'));
      document.getElementById('menu-'+name).classList.add('active');

      // éšè—æ‰€æœ‰ä¸»åŒºåŸŸå†…å®¹
      inputSection.style.display = 'none';
      knowledgeCard.style.display = 'none';
      analysisVisual.style.display = 'none';
      historyMainCard.style.display = 'none';

      // æ ¹æ®é€‰æ‹©çš„é¢æ¿æ˜¾ç¤ºç›¸åº”å†…å®¹
      if (name === 'analyze') {
        inputSection.style.display = 'block';
        analysisVisual.style.display = 'block';
      } else if (name === 'query') {
        knowledgeCard.style.display = 'block';
        // éšè—ç­”æ¡ˆåŒºåŸŸ
        kbAnswerContainer.style.display = 'none';
        kbRadarContainer.style.display = 'none';
      } else if (name === 'history') {
        historyMainCard.style.display = 'block';
        // åŒæ­¥ä¸»åŒºåŸŸå†å²è®°å½•
        syncMainHistory();
      }
    }

    // åŒæ­¥ä¸»åŒºåŸŸå†å²è®°å½•
    function syncMainHistory() {
      historyMainList.innerHTML = historyList.innerHTML;
    }

    // æµ‹è¯•APIè¿æ¥
    btnTestApi.addEventListener('click', testApiConnection);

    // ç¤ºä¾‹åºåˆ—
    btnSample.addEventListener('click', ()=>{
      seqInput.value = 'ATGCGTACGTTAGCTAGCTGACTGATCGATCGATGCTAGCTAGCTGACTGGGATGCTAGCTAGCTAGCTGACTGATCGATCGGATC' +
                       'TAGCTAGCTGATCGATCGATGCTAGCTAGCTAGCTGACTGATCGATCGATGCGTACGTTAGCTAGCTGACTGATCGATCGATGCT' +
                       'GATCGATCGATGCTAGCTAGCTAGCTGACTGATCGATCGATGCGTACGTTAGCTAGCTGACTGATCGATCGATGCTAGCTAGCT' +
                       'AGCTGACTGATCGATCGATGCGTACGTTAGCTAGCTGACTGATCGATCGATGCTAGCTAGCTAGCTGACTGATCGATCGGATCT';
    });

    // æ¸…ç©ºè¾“å…¥
    btnClear.addEventListener('click', ()=>{
      seqInput.value='';
      resultOutput.textContent='æš‚æ— åˆ†æç»“æœã€‚è¯·å…ˆè¾“å…¥åºåˆ—å¹¶ç‚¹å‡»"åˆ†æåºåˆ—"ã€‚';
      // æ¸…é™¤æ¦‚ç‡åˆ†å¸ƒ
      drawProbabilityBars(null);
      // æ¸…é™¤é›·è¾¾å›¾
      if (radarChart) {
        radarChart.destroy();
        radarChart = null;
      }
      document.getElementById('radar-container').innerHTML = '<canvas id="radar-chart" class="radar-chart"></canvas>';
    });

    // æ·»åŠ å†å²è®°å½•
    function addHistory(role, text){
      const div = document.createElement('div');
      div.className='item';
      div.textContent = (role==='user' ? 'ç”¨æˆ·: ' : 'åŠ©æ‰‹: ') + text;
      historyList.prepend(div);

      // åŒæ­¥åˆ°ä¸»åŒºåŸŸå†å²è®°å½•
      if (historyMainCard.style.display !== 'none') {
        const mainDiv = div.cloneNode(true);
        mainDiv.className = 'item';
        historyMainList.prepend(mainDiv);
      }

      // ç§»é™¤"æš‚æ— å†å²è®°å½•"
      const noHistory = historyList.querySelector('.item:last-child');
      if (noHistory && noHistory.textContent.includes('æš‚æ— å†å²è®°å½•')) {
        historyList.removeChild(noHistory);
      }

      // ç§»é™¤ä¸»åŒºåŸŸçš„"æš‚æ— å†å²è®°å½•"
      const noHistoryMain = historyMainList.querySelector('.item:last-child');
      if (noHistoryMain && noHistoryMain.textContent.includes('æš‚æ— å†å²è®°å½•')) {
        historyMainList.removeChild(noHistoryMain);
      }
    }

    // åˆ†ææŒ‰é’®ç‚¹å‡»äº‹ä»¶
    btnAnalyze.addEventListener('click', async ()=>{
      const seq = seqInput.value.trim().replace(/\s/g, ''); // ç§»é™¤ç©ºæ ¼
      const seqLength = seq.length;

      // æ£€æŸ¥åºåˆ—é•¿åº¦
      if (seqLength < 1500) {
        // æ˜¾ç¤ºè­¦å‘Šå¯¹è¯æ¡†
        sequenceLength.textContent = seqLength;
        warningModal.style.display = 'flex';

        // ç­‰å¾…ç”¨æˆ·é€‰æ‹©
        return new Promise((resolve) => {
          warningContinue.onclick = () => {
            warningModal.style.display = 'none';
            performAnalysis(seq, seqLength);
            resolve();
          };

          warningCancel.onclick = () => {
            warningModal.style.display = 'none';
            setLoading(btnAnalyze, analyzeText, analyzeLoading, false);
            resolve();
          };
        });
      } else {
        // åºåˆ—é•¿åº¦è¶³å¤Ÿï¼Œç›´æ¥åˆ†æ
        performAnalysis(seq, seqLength);
      }
    });

    // æ‰§è¡Œåˆ†æå‡½æ•°
    async function performAnalysis(seq, seqLength) {
      try {
        setLoading(btnAnalyze, analyzeText, analyzeLoading, true);
        resultOutput.textContent = 'æ­£åœ¨è¿æ¥AIæ¨¡å‹è¿›è¡Œåˆ†æ...';

        const result = await analyzeSequence(seq);

        // æ˜¾ç¤ºåˆ†æç»“æœ - æ·»åŠ è‡ªå®šä¹‰æ ‡é¢˜å¹¶æ ¼å¼åŒ–æŠ¥å‘Š
        let reportContent = result.report || result.answer || 'åˆ†æå®Œæˆ';

        // æ ¼å¼åŒ–æŠ¥å‘Šå†…å®¹
        reportContent = formatAnalysisReport(reportContent);

        // åˆ›å»ºå¸¦æœ‰è‡ªå®šä¹‰æ ‡é¢˜çš„HTMLå†…å®¹
        const formattedHTML = `<div class="analysis-report-title">ğŸ§¬ DNAåºåˆ—åˆ†ææŠ¥å‘Š (${seqLength} bp)</div>${reportContent}`;
        resultOutput.innerHTML = formattedHTML;

        // æ›´æ–°æ¦‚ç‡åˆ†å¸ƒ - ä½¿ç”¨é•¿æ¡å½¢å›¾
        if (result.probabilities || result.class_probabilities) {
          const probabilities = result.probabilities || result.class_probabilities;
          drawProbabilityBars(probabilities);
        } else if (result.top_prediction) {
          // å¦‚æœåªæœ‰top_predictionï¼Œåˆ›å»ºä¸€ä¸ªå•ä¸€æ¡å½¢
          const top = result.top_prediction;
          const probabilities = {};
          probabilities[top.chinese_name] = top.probability;
          drawProbabilityBars(probabilities);
        } else {
          drawProbabilityBars(null);
        }

        // æ›´æ–°å»ºè®® - æ˜¾ç¤ºé›·è¾¾å›¾
        const radarContainer = document.getElementById('radar-container');
        if (result.radar_chart_data) {
          // ä½¿ç”¨é›·è¾¾å›¾æ•°æ®ç»˜åˆ¶å›¾è¡¨
          try {
            radarChart = drawRadarChart(result.radar_chart_data, result.predicted_class_cn, document.getElementById('radar-chart'), radarChart);
          } catch (error) {
            console.error('ç»˜åˆ¶é›·è¾¾å›¾å¤±è´¥:', error);
            radarContainer.innerHTML = '<div style="color: var(--muted); text-align: center;">é›·è¾¾å›¾ç”Ÿæˆå¤±è´¥</div>';
          }
        } else {
          radarContainer.innerHTML = '<div style="color: var(--muted); text-align: center;">æš‚æ— é›·è¾¾å›¾æ•°æ®</div>';
        }

        addHistory('user', `åºåˆ—åˆ†æ: ${seq.slice(0,80)}${seq.length > 80 ? '...' : ''}`);
        addHistory('assistant', `é¢„æµ‹: ${result.predicted_class_cn || 'æœªçŸ¥'} (${result.confidence ? (result.confidence*100).toFixed(1)+'%' : 'åˆ†æå®Œæˆ'})`);

      } catch (error) {
        console.error('åˆ†æå¤±è´¥:', error);
        resultOutput.textContent = `åˆ†æå¤±è´¥: ${error.message}`;
        addHistory('assistant', `åˆ†æå¤±è´¥: ${error.message}`);
      } finally {
        setLoading(btnAnalyze, analyzeText, analyzeLoading, false);
      }
    }

    // çŸ¥è¯†åº“æŸ¥è¯¢
    document.getElementById('btn-kb')?.addEventListener('click', async ()=>{
      const question = document.getElementById('kb-input').value.trim();

      try {
        setLoading(document.getElementById('btn-kb'), kbText, kbLoading, true);

        const result = await queryKnowledge(question);

        // å¤„ç†ä¸åŒç±»å‹çš„å“åº”
        if (result.type === 'radar_single' || result.type === 'radar_comparison') {
          // é›·è¾¾å›¾å“åº”
          kbAnswerContent.textContent = result.description || `æ˜¾ç¤º${result.strain_name}çš„é›·è¾¾å›¾`;

          // æ˜¾ç¤ºé›·è¾¾å›¾ - ä½¿ç”¨é›·è¾¾å›¾æ•°æ®ç»˜åˆ¶
          if (result.radar_chart_data) {
            // åˆ›å»ºcanvaså…ƒç´ ç”¨äºç»˜åˆ¶é›·è¾¾å›¾
            kbRadarImageContainer.innerHTML = '';
            const canvas = document.createElement('canvas');
            canvas.id = 'kb-radar-chart';
            canvas.className = 'kb-radar-image';
            canvas.style.maxWidth = '100%';
            canvas.style.maxHeight = '350px';
            kbRadarImageContainer.appendChild(canvas);

            // ç»˜åˆ¶é›·è¾¾å›¾
            setTimeout(() => {
              try {
                const strainName = result.type === 'radar_comparison' ?
                  `${result.strain1.name} vs ${result.strain2.name}` :
                  result.strain_name;
                kbRadarChart = drawRadarChart(result.radar_chart_data, strainName, canvas, kbRadarChart);
              } catch (error) {
                console.error('ç»˜åˆ¶çŸ¥è¯†åº“é›·è¾¾å›¾å¤±è´¥:', error);
                kbRadarImageContainer.innerHTML = '<div style="color: var(--muted); text-align: center;">é›·è¾¾å›¾ç”Ÿæˆå¤±è´¥</div>';
              }
            }, 100);

            kbRadarContainer.style.display = 'block';
          }
        } else {
          // æ™®é€šæ–‡æœ¬å“åº”
          kbAnswerContent.textContent = result.answer || result.response || 'æŸ¥è¯¢å®Œæˆ';
          kbRadarContainer.style.display = 'none';
        }

        kbAnswerContainer.style.display = 'block';
        kbAnswerContainer.classList.add('fade-in');

        // è‡ªåŠ¨æ»šåŠ¨åˆ°ç­”æ¡ˆå®¹å™¨é¡¶éƒ¨ï¼Œç¡®ä¿æœç´¢æ¡†ä¸è¢«é®æŒ¡
        kbAnswerContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

        addHistory('user', question);
        addHistory('assistant', result.answer || result.response || 'æŸ¥è¯¢å®Œæˆ');

      } catch (error) {
        console.error('æŸ¥è¯¢å¤±è´¥:', error);
        kbAnswerContent.textContent = `æŸ¥è¯¢å¤±è´¥: ${error.message}`;
        kbAnswerContainer.style.display = 'block';
        kbAnswerContainer.classList.add('fade-in');
        kbRadarContainer.style.display = 'none';

        addHistory('assistant', `æŸ¥è¯¢å¤±è´¥: ${error.message}`);
      } finally {
        setLoading(document.getElementById('btn-kb'), kbText, kbLoading, false);
      }
    });

    // å¿«æ·é”® Ctrl+Enter åˆ†æ
    window.addEventListener('keydown', (e)=>{
      if(e.ctrlKey && e.key === 'Enter'){
        btnAnalyze.click();
      }
    });

    // å†å²æ§åˆ¶
    document.getElementById('btn-clear-history').addEventListener('click', ()=>{
      historyList.innerHTML='<div class="item">æš‚æ— å†å²è®°å½•</div>';
      historyMainList.innerHTML='<div class="item">æš‚æ— å†å²è®°å½•</div>';
    });

    // ä¸»åŒºåŸŸå†å²æ§åˆ¶
    document.getElementById('btn-clear-history-main').addEventListener('click', ()=>{
      historyList.innerHTML='<div class="item">æš‚æ— å†å²è®°å½•</div>';
      historyMainList.innerHTML='<div class="item">æš‚æ— å†å²è®°å½•</div>';
    });

    document.getElementById('btn-export').addEventListener('click', ()=>{
      const historyItems = Array.from(historyList.querySelectorAll('.item')).map(item => item.textContent).join('\n');
      const blob = new Blob([historyItems], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ç»†èŒåˆ†æå†å².txt';
      a.click();
      URL.revokeObjectURL(url);
    });

    // ä¸»åŒºåŸŸå¯¼å‡º
    document.getElementById('btn-export-main').addEventListener('click', ()=>{
      const historyItems = Array.from(historyMainList.querySelectorAll('.item')).map(item => item.textContent).join('\n');
      const blob = new Blob([historyItems], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ç»†èŒåˆ†æå†å².txt';
      a.click();
      URL.revokeObjectURL(url);
    });

    // API URL å˜æ›´ç›‘å¬
    apiUrlInput.addEventListener('change', testApiConnection);

    // é¡µé¢åŠ è½½åæµ‹è¯•è¿æ¥
    window.addEventListener('load', ()=>{
      testApiConnection();
    });

  </script>
  <a href="/theshow" class="upload-server-btn" id="upload-server-btn">
    èŒç§è´©å–
  </a>
</body>
</html>